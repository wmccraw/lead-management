<!DOCTYPE html>
       <html lang="en">
       <head>
         <meta charset="UTF-8">
         <meta name="viewport" content="width=device-width, initial-scale=1.0">
         <title>Lead Management System</title>
         <script src="https://cdn.tailwindcss.com"></script>
         <style>
           .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 50; }
           .modal-content { background: white; margin: 5% auto; padding: 20px; width: 90%; max-width: 600px; border-radius: 8px; max-height: 80vh; overflow-y: auto; }
           .time-green { background-color: #d4edda; }
           .time-yellow { background-color: #fff3cd; }
           .time-red { background-color: #f8d7da; }
           .lead-details { display: none; }
           .lead-details.show { display: block; }
           @media (max-width: 639px) {
             .lead-card { border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 1rem; }
             .lead-card-header { padding: 1rem; }
             .lead-card-details { padding: 1rem; border-top: 1px solid #e5e7eb; }
             .action-btn { min-width: 48px; min-height: 48px; }
           }
           @media (min-width: 640px) {
             table { table-layout: fixed; }
             th, td { word-wrap: break-word; overflow: hidden; text-overflow: ellipsis; }
           }
         </style>
       </head>
       <body class="bg-gray-100">
         <!-- Login Form -->
         <div id="login-form" class="flex items-center justify-center min-h-screen">
           <div class="bg-white p-6 rounded shadow-md w-full max-w-md">
             <h2 class="text-2xl font-bold mb-4 text-center">Login</h2>
             <input id="username" type="text" placeholder="Username" class="w-full p-3 text-base border rounded mb-4">
             <input id="password" type="password" placeholder="Password" class="w-full p-3 text-base border rounded mb-4">
             <button onclick="login()" class="w-full bg-blue-500 text-white p-3 rounded text-base hover:bg-blue-600">Login</button>
             <p id="login-error" class="text-red-500 mt-2 text-base hidden">Invalid credentials</p>
           </div>
         </div>

         <!-- Dashboard -->
         <div id="dashboard" class="hidden p-4 sm:p-6">
           <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4">
             <h2 class="text-2xl font-bold mb-4 sm:mb-0">Leads Dashboard</h2>
             <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded text-base hover:bg-red-600">Logout</button>
           </div>
           <input id="search-bar" type="text" placeholder="Search leads..." class="w-full p-3 text-base border rounded mb-4" oninput="filterLeads()">
           <button onclick="openLeadModal('create')" class="w-full sm:w-auto bg-blue-500 text-white px-4 py-2 mb-4 rounded text-base hover:bg-blue-600">Create Lead</button>
           <!-- Mobile Card Layout -->
           <div id="leads-cards" class="block sm:hidden"></div>
           <!-- Desktop Table Layout -->
           <div class="hidden sm:block overflow-x-auto">
             <table class="w-full bg-white shadow-md rounded">
               <thead>
                 <tr class="bg-gray-200">
                   <th class="p-2 text-left">ID</th>
                   <th class="p-2 text-left">Customer Name</th>
                   <th class="p-2 text-left">Company</th>
                   <th class="p-2 text-left">Email</th>
                   <th class="p-2 text-left">Phone</th>
                   <th class="p-2 text-left">Street</th>
                   <th class="p-2 text-left">City</th>
                   <th class="p-2 text-left">State</th>
                   <th class="p-2 text-left">ZIP</th>
                   <th class="p-2 text-left">Categories</th>
                   <th class="p-2 text-left">Make</th>
                   <th class="p-2 text-left">Model</th>
                   <th class="p-2 text-left">Notes</th>
                   <th class="p-2 text-left">Status</th>
                   <th class="p-2 text-left">Time in System</th>
                   <th class="p-2 text-left">Actions</th>
                 </tr>
               </thead>
               <tbody id="leads-table"></tbody>
             </table>
           </div>
         </div>

         <!-- Lead Modal (Create/Edit) -->
         <div id="lead-modal" class="modal">
           <div class="modal-content p-4 sm:p-6">
             <h2 id="modal-title" class="text-xl font-bold mb-4">Create Lead</h2>
             <form id="lead-form">
               <div class="mb-4">
                 <label class="block text-base font-medium mb-1">Customer Name *</label>
                 <input id="customerName" type="text" class="w-full p-3 text-base border rounded" required>
               </div>
               <div class="mb-4">
                 <label class="block text-base font-medium mb-1">Company</label>
                 <input id="company" type="text" class="w-full p-3 text-base border rounded">
               </div>
               <div class="mb-4">
                 <label class="block text-base font-medium mb-1">Customer Email</label>
                 <input id="customerEmail" type="email" class="w-full p-3 text-base border rounded">
               </div>
               <div class="mb-4">
                 <label class="block text-base font-medium mb-1">Customer Phone</label>
                 <input id="customerPhone" type="tel" class="w-full p-3 text-base border rounded">
               </div>
               <div class="mb-4">
                 <label class="block text-base font-medium mb-1">Street Address</label>
                 <input id="customerStreet" type="text" class="w-full p-3 text-base border rounded">
               </div>
               <div class="mb-4">
                 <label class="block text-base font-medium mb-1">City</label>
                 <input id="customerCity" type="text" class="w-full p-3 text-base border rounded">
               </div>
               <div class="mb-4">
                 <label class="block text-base font-medium mb-1">State</label>
                 <input id="customerState" type="text" class="w-full p-3 text-base border rounded">
               </div>
               <div class="mb-4">
                 <label class="block text-base font-medium mb-1">ZIP Code</label>
                 <input id="customerZip" type="text" class="w-full p-3 text-base border rounded">
               </div>
               <div class="mb-4">
                 <label class="block text-base font-medium mb-1">Categories</label>
                 <input id="categories" type="text" class="w-full p-3 text-base border rounded" placeholder="e.g., Excavator,Crusher">
               </div>
               <div class="mb-4">
                 <label class="block text-base font-medium mb-1">Make</label>
                 <input id="make" type="text" class="w-full p-3 text-base border rounded">
               </div>
               <div class="mb-4">
                 <label class="block text-base font-medium mb-1">Model</label>
                 <input id="model" type="text" class="w-full p-3 text-base border rounded">
               </div>
               <div class="mb-4">
                 <label class="block text-base font-medium mb-1">Machines Notes</label>
                 <textarea id="machinesNotes" class="w-full p-3 text-base border rounded"></textarea>
               </div>
               <div class="mb-4">
                 <label class="block text-base font-medium mb-1">Status</label>
                 <select id="status" class="w-full p-3 text-base border rounded">
                   <option value="Quoted">Quoted</option>
                   <option value="Closed">Closed</option>
                   <option value="Pending">Pending</option>
                   <option value="Lost">Lost</option>
                 </select>
               </div>
               <div class="flex justify-end space-x-4">
                 <button type="button" onclick="closeLeadModal()" class="bg-gray-500 text-white px-4 py-2 rounded text-base hover:bg-gray-600">Cancel</button>
                 <button type="submit" id="save-lead-btn" class="bg-blue-500 text-white px-4 py-2 rounded text-base hover:bg-blue-600">Save Lead</button>
               </div>
             </form>
           </div>
         </div>

         <script>
           let token = null;
           let currentLeadId = null;

           // Login
           async function login() {
             const username = document.getElementById('username').value;
             const password = document.getElementById('password').value;
             try {
               const response = await fetch('/api/login', {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify({ username, password })
               });
               const data = await response.json();
               if (data.token) {
                 token = data.token;
                 document.getElementById('login-form').classList.add('hidden');
                 document.getElementById('dashboard').classList.remove('hidden');
                 loadLeads();
               } else {
                 document.getElementById('login-error').classList.remove('hidden');
               }
             } catch (err) {
               document.getElementById('login-error').classList.remove('hidden');
             }
           }

           // Logout
           function logout() {
             token = null;
             document.getElementById('dashboard').classList.add('hidden');
             document.getElementById('login-form').classList.remove('hidden');
             document.getElementById('username').value = '';
             document.getElementById('password').value = '';
             document.getElementById('login-error').classList.add('hidden');
           }

           // Load Leads
           async function loadLeads() {
             try {
               const response = await fetch('/api/leads', {
                 headers: { 'Authorization': `Bearer ${token}` }
               });
               const leads = await response.json();
               renderLeads(leads);
             } catch (err) {
               console.error('Error loading leads:', err);
             }
           }

           // Render Leads (Cards for Mobile, Table for Desktop)
           function renderLeads(leads) {
             const tableBody = document.getElementById('leads-table');
             const cardsContainer = document.getElementById('leads-cards');
             tableBody.innerHTML = '';
             cardsContainer.innerHTML = '';

             leads.forEach(lead => {
               const timeInSystem = calculateTimeInSystem(lead.created_at);

               // Desktop Table Row
               const row = document.createElement('tr');
               row.innerHTML = `
                 <td class="p-2">${lead.id}</td>
                 <td class="p-2">${lead.customer_name}</td>
                 <td class="p-2">${lead.company || ''}</td>
                 <td class="p-2">${lead.customer_email || ''}</td>
                 <td class="p-2">${lead.customer_phone || ''}</td>
                 <td class="p-2">${lead.customer_street || ''}</td>
                 <td class="p-2">${lead.customer_city || ''}</td>
                 <td class="p-2">${lead.customer_state || ''}</td>
                 <td class="p-2">${lead.customer_zip || ''}</td>
                 <td class="p-2">${lead.categories || ''}</td>
                 <td class="p-2">${lead.make || ''}</td>
                 <td class="p-2">${lead.model || ''}</td>
                 <td class="p-2">${lead.machines_notes || ''}</td>
                 <td class="p-2">${lead.status || ''}</td>
                 <td class="p-2 ${timeInSystem.class}">${timeInSystem.text}</td>
                 <td class="p-2">
                   <button onclick="editLead(${lead.id})" class="bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600">Edit</button>
                   <button onclick="deleteLead(${lead.id})" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Delete</button>
                 </td>
               `;
               tableBody.appendChild(row);

               // Mobile Card
               const card = document.createElement('div');
               card.className = 'lead-card bg-white';
               card.innerHTML = `
                 <div class="lead-card-header">
                   <h3 class="text-lg font-semibold">${lead.customer_name}</h3>
                   <p class="text-base">${lead.company || 'No Company'}</p>
                   <p class="text-base">Status: ${lead.status || 'N/A'}</p>
                   <p class="text-base ${timeInSystem.class} p-1 rounded">Time: ${timeInSystem.text}</p>
                   <button onclick="toggleDetails(${lead.id})" class="text-blue-500 text-base mt-2">Show Details</button>
                 </div>
                 <div id="details-${lead.id}" class="lead-details lead-card-details">
                   <p><strong>Email:</strong> ${lead.customer_email || 'N/A'}</p>
                   <p><strong>Phone:</strong> ${lead.customer_phone || 'N/A'}</p>
                   <p><strong>Street:</strong> ${lead.customer_street || 'N/A'}</p>
                   <p><strong>City:</strong> ${lead.customer_city || 'N/A'}</p>
                   <p><strong>State:</strong> ${lead.customer_state || 'N/A'}</p>
                   <p><strong>ZIP:</strong> ${lead.customer_zip || 'N/A'}</p>
                   <p><strong>Categories:</strong> ${lead.categories || 'N/A'}</p>
                   <p><strong>Make:</strong> ${lead.make || 'N/A'}</p>
                   <p><strong>Model:</strong> ${lead.model || 'N/A'}</p>
                   <p><strong>Notes:</strong> ${lead.machines_notes || 'N/A'}</p>
                   <div class="flex space-x-4 mt-4">
                     <button onclick="editLead(${lead.id})" class="action-btn bg-yellow-500 text-white px-4 py-2 rounded text-base hover:bg-yellow-600">Edit</button>
                     <button onclick="deleteLead(${lead.id})" class="action-btn bg-red-500 text-white px-4 py-2 rounded text-base hover:bg-red-600">Delete</button>
                   </div>
                 </div>
               `;
               cardsContainer.appendChild(card);
             });
           }

           // Toggle Card Details
           function toggleDetails(leadId) {
             const details = document.getElementById(`details-${leadId}`);
             details.classList.toggle('show');
           }

           // Calculate Time in System
           function calculateTimeInSystem(createdAt) {
             const now = new Date();
             const created = new Date(createdAt);
             const diffMs = now - created;
             const hours = Math.floor(diffMs / (1000 * 60 * 60));
             const days = Math.floor(hours / 24);
             let text = hours < 24 ? `${hours} hours` : `${days} days`;
             let className = hours < 24 ? 'time-green' : hours < 72 ? 'time-yellow' : 'time-red';
             return { text, class: className };
           }

           // Filter Leads
           function filterLeads() {
             const search = document.getElementById('search-bar').value.toLowerCase();
             const cards = document.getElementById('leads-cards').getElementsByClassName('lead-card');
             const rows = document.getElementById('leads-table').getElementsByTagName('tr');
             // Filter Cards
             for (let card of cards) {
               const text = card.textContent.toLowerCase();
               card.style.display = text.includes(search) ? '' : 'none';
             }
             // Filter Table Rows
             for (let row of rows) {
               const cells = row.getElementsByTagName('td');
               let match = false;
               for (let cell of cells) {
                 if (cell.textContent.toLowerCase().includes(search)) {
                   match = true;
                   break;
                 }
               }
               row.style.display = match ? '' : 'none';
             }
           }

           // Open Lead Modal (Create or Edit)
           async function openLeadModal(mode, leadId = null) {
             const modal = document.getElementById('lead-modal');
             const form = document.getElementById('lead-form');
             const title = document.getElementById('modal-title');
             const saveBtn = document.getElementById('save-lead-btn');
             currentLeadId = leadId;

             form.reset();
             modal.style.display = 'flex';
             if (mode === 'create') {
               title.textContent = 'Create Lead';
               saveBtn.textContent = 'Save Lead';
             } else {
               title.textContent = 'Edit Lead';
               saveBtn.textContent = 'Update Lead';
               try {
                 const response = await fetch(`/api/leads`, {
                   headers: { 'Authorization': `Bearer ${token}` }
                 });
                 const leads = await response.json();
                 const lead = leads.find(l => l.id === leadId);
                 if (lead) {
                   document.getElementById('customerName').value = lead.customer_name || '';
                   document.getElementById('company').value = lead.company || '';
                   document.getElementById('customerEmail').value = lead.customer_email || '';
                   document.getElementById('customerPhone').value = lead.customer_phone || '';
                   document.getElementById('customerStreet').value = lead.customer_street || '';
                   document.getElementById('customerCity').value = lead.customer_city || '';
                   document.getElementById('customerState').value = lead.customer_state || '';
                   document.getElementById('customerZip').value = lead.customer_zip || '';
                   document.getElementById('categories').value = lead.categories || '';
                   document.getElementById('make').value = lead.make || '';
                   document.getElementById('model').value = lead.model || '';
                   document.getElementById('machinesNotes').value = lead.machines_notes || '';
                   document.getElementById('status').value = lead.status || 'Quoted';
                 }
               } catch (err) {
                 console.error('Error loading lead:', err);
                 alert('Error loading lead');
                 closeLeadModal();
               }
             }
           }

           // Close Lead Modal
           function closeLeadModal() {
             document.getElementById('lead-modal').style.display = 'none';
             currentLeadId = null;
           }

           // Save or Update Lead
           document.getElementById('lead-form').addEventListener('submit', async (e) => {
             e.preventDefault();
             const lead = {
               customerName: document.getElementById('customerName').value,
               company: document.getElementById('company').value,
               customerEmail: document.getElementById('customerEmail').value,
               customerPhone: document.getElementById('customerPhone').value,
               customerStreet: document.getElementById('customerStreet').value,
               customerCity: document.getElementById('customerCity').value,
               customerState: document.getElementById('customerState').value,
               customerZip: document.getElementById('customerZip').value,
               categories: document.getElementById('categories').value,
               make: document.getElementById('make').value,
               model: document.getElementById('model').value,
               machinesNotes: document.getElementById('machinesNotes').value,
               status: document.getElementById('status').value
             };

             try {
               const url = currentLeadId ? `/api/leads/${currentLeadId}` : '/api/leads';
               const method = currentLeadId ? 'PUT' : 'POST';
               const response = await fetch(url, {
                 method,
                 headers: {
                   'Content-Type': 'application/json',
                   'Authorization': `Bearer ${token}`
                 },
                 body: JSON.stringify(lead)
               });
               if (response.ok) {
                 closeLeadModal();
                 loadLeads();
               } else {
                 alert(currentLeadId ? 'Error updating lead' : 'Error saving lead');
               }
             } catch (err) {
               alert(currentLeadId ? 'Error updating lead' : 'Error saving lead');
             }
           });

           // Edit Lead
           function editLead(id) {
             openLeadModal('edit', id);
           }

           // Delete Lead
           async function deleteLead(id) {
             if (confirm('Are you sure you want to delete this lead?')) {
               try {
                 const response = await fetch(`/api/leads/${id}`, {
                   method: 'DELETE',
                   headers: { 'Authorization': `Bearer ${token}` }
                 });
                 if (response.ok) {
                   loadLeads();
                 } else {
                   alert('Error deleting lead');
                 }
               } catch (err) {
                 alert('Error deleting lead');
               }
             }
           }
         </script>
       </body>
       </html>