<!DOCTYPE html>
       <html lang="en">
       <head>
         <meta charset="UTF-8">
         <meta name="viewport" content="width=device-width, initial-scale=1.0">
         <title>Lead Management System</title>
         <script src="https://cdn.tailwindcss.com"></script>
         <style>
           .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 50; }
           .modal-content { background: white; margin: 5% auto; padding: 20px; width: 90%; max-width: 600px; border-radius: 8px; max-height: 80vh; overflow-y: auto; }
           .time-green { background-color: #d4edda; }
           .time-yellow { background-color: #fff3cd; }
           .time-red { background-color: #f8d7da; }
         </style>
       </head>
       <body class="bg-gray-100">
         <!-- Login Form -->
         <div id="login-form" class="flex items-center justify-center min-h-screen">
           <div class="bg-white p-6 rounded shadow-md w-full max-w-md">
             <h2 class="text-2xl font-bold mb-4 text-center">Login</h2>
             <input id="username" type="text" placeholder="Username" class="w-full p-2 mb-4 border rounded">
             <input id="password" type="password" placeholder="Password" class="w-full p-2 mb-4 border rounded">
             <button onclick="login()" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Login</button>
             <p id="login-error" class="text-red-500 mt-2 hidden">Invalid credentials</p>
           </div>
         </div>

         <!-- Dashboard -->
         <div id="dashboard" class="hidden p-4">
           <div class="flex justify-between items-center mb-4">
             <h2 class="text-2xl font-bold">Leads Dashboard</h2>
             <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Logout</button>
           </div>
           <input id="search-bar" type="text" placeholder="Search leads..." class="w-full p-2 mb-4 border rounded" oninput="filterLeads()">
           <button onclick="openCreateLeadModal()" class="bg-blue-500 text-white px-4 py-2 mb-4 rounded hover:bg-blue-600">Create Lead</button>
           <table class="w-full bg-white shadow-md rounded">
             <thead>
               <tr class="bg-gray-200">
                 <th class="p-2 text-left">ID</th>
                 <th class="p-2 text-left">Customer Name</th>
                 <th class="p-2 text-left">Categories</th>
                 <th class="p-2 text-left">Make</th>
                 <th class="p-2 text-left">Model</th>
                 <th class="p-2 text-left">Status</th>
                 <th class="p-2 text-left">Time in System</th>
                 <th class="p-2 text-left">Actions</th>
               </tr>
             </thead>
             <tbody id="leads-table"></tbody>
           </table>
         </div>

         <!-- Create Lead Modal -->
         <div id="create-lead-modal" class="modal">
           <div class="modal-content">
             <h2 class="text-xl font-bold mb-4">Create Lead</h2>
             <form id="create-lead-form">
               <div class="mb-4">
                 <label class="block text-sm font-medium mb-1">Customer Name *</label>
                 <input id="customerName" type="text" class="w-full p-2 border rounded" required>
               </div>
               <div class="mb-4">
                 <label class="block text-sm font-medium mb-1">Customer Email</label>
                 <input id="customerEmail" type="email" class="w-full p-2 border rounded">
               </div>
               <div class="mb-4">
                 <label class="block text-sm font-medium mb-1">Customer Phone</label>
                 <input id="customerPhone" type="tel" class="w-full p-2 border rounded">
               </div>
               <div class="mb-4">
                 <label class="block text-sm font-medium mb-1">Street Address</label>
                 <input id="customerStreet" type="text" class="w-full p-2 border rounded">
               </div>
               <div class="mb-4">
                 <label class="block text-sm font-medium mb-1">City</label>
                 <input id="customerCity" type="text" class="w-full p-2 border rounded">
               </div>
               <div class="mb-4">
                 <label class="block text-sm font-medium mb-1">State</label>
                 <input id="customerState" type="text" class="w-full p-2 border rounded">
               </div>
               <div class="mb-4">
                 <label class="block text-sm font-medium mb-1">ZIP Code</label>
                 <input id="customerZip" type="text" class="w-full p-2 border rounded">
               </div>
               <div class="mb-4">
                 <label class="block text-sm font-medium mb-1">Categories</label>
                 <select id="categories" multiple class="w-full p-2 border rounded">
                   <!-- Populated dynamically -->
                 </select>
               </div>
               <div class="mb-4">
                 <label class="block text-sm font-medium mb-1">Make</label>
                 <select id="make" class="w-full p-2 border rounded">
                   <option value="">Select Make</option>
                   <!-- Populated dynamically -->
                 </select>
               </div>
               <div class="mb-4">
                 <label class="block text-sm font-medium mb-1">Model</label>
                 <select id="model" class="w-full p-2 border rounded">
                   <option value="">Select Model</option>
                   <!-- Populated dynamically -->
                 </select>
               </div>
               <div class="mb-4">
                 <label class="block text-sm font-medium mb-1">Company</label>
                 <input id="company" type="text" class="w-full p-2 border rounded">
               </div>
               <div class="mb-4">
                 <label class="block text-sm font-medium mb-1">Machines Notes</label>
                 <textarea id="machinesNotes" class="w-full p-2 border rounded"></textarea>
               </div>
               <div class="mb-4">
                 <label class="block text-sm font-medium mb-1">Status</label>
                 <select id="status" class="w-full p-2 border rounded">
                   <option value="Quoted">Quoted</option>
                   <option value="Closed">Closed</option>
                   <option value="Pending">Pending</option>
                 </select>
               </div>
               <div class="flex justify-end">
                 <button type="button" onclick="closeCreateLeadModal()" class="bg-gray-500 text-white px-4 py-2 rounded mr-2 hover:bg-gray-600">Cancel</button>
                 <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Save Lead</button>
               </div>
             </form>
           </div>
         </div>

         <script>
           let token = null;

           // Login
           async function login() {
             const username = document.getElementById('username').value;
             const password = document.getElementById('password').value;
             try {
               const response = await fetch('/api/login', {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify({ username, password })
               });
               const data = await response.json();
               if (data.token) {
                 token = data.token;
                 document.getElementById('login-form').classList.add('hidden');
                 document.getElementById('dashboard').classList.remove('hidden');
                 loadLeads();
                 loadCategories();
                 loadMakes();
                 loadModels();
               } else {
                 document.getElementById('login-error').classList.remove('hidden');
               }
             } catch (err) {
               document.getElementById('login-error').classList.remove('hidden');
             }
           }

           // Logout
           function logout() {
             token = null;
             document.getElementById('dashboard').classList.add('hidden');
             document.getElementById('login-form').classList.remove('hidden');
             document.getElementById('username').value = '';
             document.getElementById('password').value = '';
             document.getElementById('login-error').classList.add('hidden');
           }

           // Load Leads
           async function loadLeads() {
             try {
               const response = await fetch('/api/leads', {
                 headers: { 'Authorization': `Bearer ${token}` }
               });
               const leads = await response.json();
               const tableBody = document.getElementById('leads-table');
               tableBody.innerHTML = '';
               leads.forEach(lead => {
                 const timeInSystem = calculateTimeInSystem(lead.created_at);
                 const row = document.createElement('tr');
                 row.innerHTML = `
                   <td class="p-2">${lead.id}</td>
                   <td class="p-2">${lead.customer_name}</td>
                   <td class="p-2">${lead.categories || ''}</td>
                   <td class="p-2">${lead.make || ''}</td>
                   <td class="p-2">${lead.model || ''}</td>
                   <td class="p-2">${lead.status || ''}</td>
                   <td class="p-2 ${timeInSystem.class}">${timeInSystem.text}</td>
                   <td class="p-2">
                     <button onclick="editLead(${lead.id})" class="bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600">Edit</button>
                     <button onclick="deleteLead(${lead.id})" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Delete</button>
                   </td>
                 `;
                 tableBody.appendChild(row);
               });
             } catch (err) {
               console.error('Error loading leads:', err);
             }
           }

           // Calculate Time in System
           function calculateTimeInSystem(createdAt) {
             const now = new Date();
             const created = new Date(createdAt);
             const diffMs = now - created;
             const hours = Math.floor(diffMs / (1000 * 60 * 60));
             const days = Math.floor(hours / 24);
             let text = hours < 24 ? `${hours} hours` : `${days} days`;
             let className = hours < 24 ? 'time-green' : hours < 72 ? 'time-yellow' : 'time-red';
             return { text, class: className };
           }

           // Filter Leads
           function filterLeads() {
             const search = document.getElementById('search-bar').value.toLowerCase();
             const rows = document.getElementById('leads-table').getElementsByTagName('tr');
             for (let row of rows) {
               const cells = row.getElementsByTagName('td');
               let match = false;
               for (let cell of cells) {
                 if (cell.textContent.toLowerCase().includes(search)) {
                   match = true;
                   break;
                 }
               }
               row.style.display = match ? '' : 'none';
             }
           }

           // Load Categories
           async function loadCategories() {
             try {
               const response = await fetch('/api/categories', {
                 headers: { 'Authorization': `Bearer ${token}` }
               });
               const categories = await response.json();
               const select = document.getElementById('categories');
               select.innerHTML = '';
               categories.forEach(category => {
                 const option = document.createElement('option');
                 option.value = category;
                 option.textContent = category;
                 select.appendChild(option);
               });
             } catch (err) {
               console.error('Error loading categories:', err);
             }
           }

           // Load Makes
           async function loadMakes() {
             try {
               const response = await fetch('/api/makes', {
                 headers: { 'Authorization': `Bearer ${token}` }
               });
               const makes = await response.json();
               const select = document.getElementById('make');
               select.innerHTML = '<option value="">Select Make</option>';
               makes.forEach(make => {
                 const option = document.createElement('option');
                 option.value = make;
                 option.textContent = make;
                 select.appendChild(option);
               });
             } catch (err) {
               console.error('Error loading makes:', err);
             }
           }

           // Load Models
           async function loadModels() {
             try {
               const response = await fetch('/api/models', {
                 headers: { 'Authorization': `Bearer ${token}` }
               });
               const models = await response.json();
               const select = document.getElementById('model');
               select.innerHTML = '<option value="">Select Model</option>';
               models.forEach(model => {
                 const option = document.createElement('option');
                 option.value = model;
                 option.textContent = model;
                 select.appendChild(option);
               });
             } catch (err) {
               console.error('Error loading models:', err);
             }
           }

           // Open Create Lead Modal
           function openCreateLeadModal() {
             document.getElementById('create-lead-modal').style.display = 'flex';
             document.getElementById('create-lead-form').reset();
           }

           // Close Create Lead Modal
           function closeCreateLeadModal() {
             document.getElementById('create-lead-modal').style.display = 'none';
           }

           // Save Lead
           document.getElementById('create-lead-form').addEventListener('submit', async (e) => {
             e.preventDefault();
             const lead = {
               customerName: document.getElementById('customerName').value,
               customerEmail: document.getElementById('customerEmail').value,
               customerPhone: document.getElementById('customerPhone').value,
               customerStreet: document.getElementById('customerStreet').value,
               customerCity: document.getElementById('customerCity').value,
               customerState: document.getElementById('customerState').value,
               customerZip: document.getElementById('customerZip').value,
               categories: Array.from(document.getElementById('categories').selectedOptions).map(opt => opt.value),
               make: document.getElementById('make').value,
               model: document.getElementById('model').value,
               company: document.getElementById('company').value,
               machinesNotes: document.getElementById('machinesNotes').value,
               status: document.getElementById('status').value
             };
             try {
               const response = await fetch('/api/leads', {
                 method: 'POST',
                 headers: {
                   'Content-Type': 'application/json',
                   'Authorization': `Bearer ${token}`
                 },
                 body: JSON.stringify(lead)
               });
               if (response.ok) {
                 closeCreateLeadModal();
                 loadLeads();
               } else {
                 alert('Error saving lead');
               }
             } catch (err) {
               alert('Error saving lead');
             }
           });

           // Edit Lead (Placeholder)
           function editLead(id) {
             alert(`Edit lead ID ${id} - Feature to be implemented`);
           }

           // Delete Lead
           async function deleteLead(id) {
             if (confirm('Are you sure you want to delete this lead?')) {
               try {
                 const response = await fetch(`/api/leads/${id}`, {
                   method: 'DELETE',
                   headers: { 'Authorization': `Bearer ${token}` }
                 });
                 if (response.ok) {
                   loadLeads();
                 } else {
                   alert('Error deleting lead');
                 }
               } catch (err) {
                 alert('Error deleting lead');
               }
             }
           }
         </script>
       </body>
       </html>